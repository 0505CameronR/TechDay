import { ReplaySubject } from '../ReplaySubject';
export function shareReplay(configOrBufferSize, windowTime, scheduler) {
    let config;
    if (configOrBufferSize && typeof configOrBufferSize === 'object') {
        config = configOrBufferSize;
    }
    else {
        config = {
            bufferSize: configOrBufferSize,
            windowTime,
            refCount: false,
            scheduler
        };
    }
    return (source) => source.lift(shareReplayOperator(config));
}
function shareReplayOperator({ bufferSize = Number.POSITIVE_INFINITY, windowTime = Number.POSITIVE_INFINITY, refCount: useRefCount, scheduler }) {
    let subject;
    let refCount = 0;
    let subscription;
    let hasError = false;
    let isComplete = false;
    return function shareReplayOperation(source) {
        refCount++;
        if (!subject || hasError) {
            hasError = false;
            subject = new ReplaySubject(bufferSize, windowTime, scheduler);
            subscription = source.subscribe({
                next(value) { subject.next(value); },
                error(err) {
                    hasError = true;
                    subject.error(err);
                },
                complete() {
                    isComplete = true;
                    subject.complete();
                },
            });
        }
        const innerSub = subject.subscribe(this);
        this.add(() => {
            refCount--;
            innerSub.unsubscribe();
            if (subscription && !isComplete && useRefCount && refCount === 0) {
                subscription.unsubscribe();
                subscription = undefined;
                subject = undefined;
            }
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmVSZXBsYXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wbGF0Zm9ybXMvaW9zL1R1bWFpbmlGdW5kL2FwcC90bnNfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vcGVyYXRvcnMvc2hhcmVSZXBsYXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBMkRqRCxNQUFNLFVBQVUsV0FBVyxDQUN6QixrQkFBK0MsRUFDL0MsVUFBbUIsRUFDbkIsU0FBeUI7SUFFekIsSUFBSSxNQUF5QixDQUFDO0lBQzlCLElBQUksa0JBQWtCLElBQUksT0FBTyxrQkFBa0IsS0FBSyxRQUFRLEVBQUU7UUFDaEUsTUFBTSxHQUFHLGtCQUF1QyxDQUFDO0tBQ2xEO1NBQU07UUFDTCxNQUFNLEdBQUc7WUFDUCxVQUFVLEVBQUUsa0JBQXdDO1lBQ3BELFVBQVU7WUFDVixRQUFRLEVBQUUsS0FBSztZQUNmLFNBQVM7U0FDVixDQUFDO0tBQ0g7SUFDRCxPQUFPLENBQUMsTUFBcUIsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQzdFLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFJLEVBQzlCLFVBQVUsR0FBRyxNQUFNLENBQUMsaUJBQWlCLEVBQ3JDLFVBQVUsR0FBRyxNQUFNLENBQUMsaUJBQWlCLEVBQ3JDLFFBQVEsRUFBRSxXQUFXLEVBQ3JCLFNBQVMsRUFDUztJQUNsQixJQUFJLE9BQXFDLENBQUM7SUFDMUMsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLElBQUksWUFBc0MsQ0FBQztJQUMzQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFDckIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBRXZCLE9BQU8sU0FBUyxvQkFBb0IsQ0FBc0IsTUFBcUI7UUFDN0UsUUFBUSxFQUFFLENBQUM7UUFDWCxJQUFJLENBQUMsT0FBTyxJQUFJLFFBQVEsRUFBRTtZQUN4QixRQUFRLEdBQUcsS0FBSyxDQUFDO1lBQ2pCLE9BQU8sR0FBRyxJQUFJLGFBQWEsQ0FBSSxVQUFVLEVBQUUsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2xFLFlBQVksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO2dCQUM5QixJQUFJLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxLQUFLLENBQUMsR0FBRztvQkFDUCxRQUFRLEdBQUcsSUFBSSxDQUFDO29CQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNyQixDQUFDO2dCQUNELFFBQVE7b0JBQ04sVUFBVSxHQUFHLElBQUksQ0FBQztvQkFDbEIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNyQixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ1osUUFBUSxFQUFFLENBQUM7WUFDWCxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdkIsSUFBSSxZQUFZLElBQUksQ0FBQyxVQUFVLElBQUksV0FBVyxJQUFJLFFBQVEsS0FBSyxDQUFDLEVBQUU7Z0JBQ2hFLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDM0IsWUFBWSxHQUFHLFNBQVMsQ0FBQztnQkFDekIsT0FBTyxHQUFHLFNBQVMsQ0FBQzthQUNyQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICcuLi9SZXBsYXlTdWJqZWN0JztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJy4uL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb24sIFNjaGVkdWxlckxpa2UgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBTdWJzY3JpYmVyIH0gZnJvbSAnLi4vU3Vic2NyaWJlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hhcmVSZXBsYXlDb25maWcge1xuICBidWZmZXJTaXplPzogbnVtYmVyO1xuICB3aW5kb3dUaW1lPzogbnVtYmVyO1xuICByZWZDb3VudDogYm9vbGVhbjtcbiAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZTtcbn1cblxuLyoqXG4gKiBTaGFyZSBzb3VyY2UgYW5kIHJlcGxheSBzcGVjaWZpZWQgbnVtYmVyIG9mIGVtaXNzaW9ucyBvbiBzdWJzY3JpcHRpb24uXG4gKlxuICogVGhpcyBvcGVyYXRvciBpcyBhIHNwZWNpYWxpemF0aW9uIG9mIGByZXBsYXlgIHRoYXQgY29ubmVjdHMgdG8gYSBzb3VyY2Ugb2JzZXJ2YWJsZVxuICogYW5kIG11bHRpY2FzdHMgdGhyb3VnaCBhIGBSZXBsYXlTdWJqZWN0YCBjb25zdHJ1Y3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYXJndW1lbnRzLlxuICogQSBzdWNjZXNzZnVsbHkgY29tcGxldGVkIHNvdXJjZSB3aWxsIHN0YXkgY2FjaGVkIGluIHRoZSBgc2hhcmVSZXBsYXllZCBvYnNlcnZhYmxlYCBmb3JldmVyLFxuICogYnV0IGFuIGVycm9yZWQgc291cmNlIGNhbiBiZSByZXRyaWVkLlxuICpcbiAqICMjIFdoeSB1c2Ugc2hhcmVSZXBsYXk/XG4gKiBZb3UgZ2VuZXJhbGx5IHdhbnQgdG8gdXNlIGBzaGFyZVJlcGxheWAgd2hlbiB5b3UgaGF2ZSBzaWRlLWVmZmVjdHMgb3IgdGF4aW5nIGNvbXB1dGF0aW9uc1xuICogdGhhdCB5b3UgZG8gbm90IHdpc2ggdG8gYmUgZXhlY3V0ZWQgYW1vbmdzdCBtdWx0aXBsZSBzdWJzY3JpYmVycy5cbiAqIEl0IG1heSBhbHNvIGJlIHZhbHVhYmxlIGluIHNpdHVhdGlvbnMgd2hlcmUgeW91IGtub3cgeW91IHdpbGwgaGF2ZSBsYXRlIHN1YnNjcmliZXJzIHRvXG4gKiBhIHN0cmVhbSB0aGF0IG5lZWQgYWNjZXNzIHRvIHByZXZpb3VzbHkgZW1pdHRlZCB2YWx1ZXMuXG4gKiBUaGlzIGFiaWxpdHkgdG8gcmVwbGF5IHZhbHVlcyBvbiBzdWJzY3JpcHRpb24gaXMgd2hhdCBkaWZmZXJlbnRpYXRlcyB7QGxpbmsgc2hhcmV9IGFuZCBgc2hhcmVSZXBsYXlgLlxuICpcbiAqICFbXShzaGFyZVJlcGxheS5wbmcpXG4gKlxuICogIyMgRXhhbXBsZVxuICogYGBgamF2YXNjcmlwdFxuICogaW1wb3J0IHsgaW50ZXJ2YWwgfSBmcm9tICdyeGpzJztcbiAqIGltcG9ydCB7IHNoYXJlUmVwbGF5LCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuICpcbiAqIGNvbnN0IG9icyQgPSBpbnRlcnZhbCgxMDAwKTtcbiAqIGNvbnN0IHNoYXJlZCQgPSBvYnMkLnBpcGUoXG4gKiAgIHRha2UoNCksXG4gKiAgIHNoYXJlUmVwbGF5KDMpXG4gKiApO1xuICogc2hhcmVkJC5zdWJzY3JpYmUoeCA9PiBjb25zb2xlLmxvZygnc291cmNlIEE6ICcsIHgpKTtcbiAqIHNoYXJlZCQuc3Vic2NyaWJlKHkgPT4gY29uc29sZS5sb2coJ3NvdXJjZSBCOiAnLCB5KSk7XG4gKlxuICogYGBgXG4gKlxuICogQHNlZSB7QGxpbmsgcHVibGlzaH1cbiAqIEBzZWUge0BsaW5rIHNoYXJlfVxuICogQHNlZSB7QGxpbmsgcHVibGlzaFJlcGxheX1cbiAqXG4gKiBAcGFyYW0ge051bWJlcn0gW2J1ZmZlclNpemU9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZXSBNYXhpbXVtIGVsZW1lbnQgY291bnQgb2YgdGhlIHJlcGxheSBidWZmZXIuXG4gKiBAcGFyYW0ge051bWJlcn0gW3dpbmRvd1RpbWU9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZXSBNYXhpbXVtIHRpbWUgbGVuZ3RoIG9mIHRoZSByZXBsYXkgYnVmZmVyIGluIG1pbGxpc2Vjb25kcy5cbiAqIEBwYXJhbSB7U2NoZWR1bGVyfSBbc2NoZWR1bGVyXSBTY2hlZHVsZXIgd2hlcmUgY29ubmVjdGVkIG9ic2VydmVycyB3aXRoaW4gdGhlIHNlbGVjdG9yIGZ1bmN0aW9uXG4gKiB3aWxsIGJlIGludm9rZWQgb24uXG4gKiBAcmV0dXJuIHtPYnNlcnZhYmxlfSBBbiBvYnNlcnZhYmxlIHNlcXVlbmNlIHRoYXQgY29udGFpbnMgdGhlIGVsZW1lbnRzIG9mIGEgc2VxdWVuY2UgcHJvZHVjZWRcbiAqIGJ5IG11bHRpY2FzdGluZyB0aGUgc291cmNlIHNlcXVlbmNlIHdpdGhpbiBhIHNlbGVjdG9yIGZ1bmN0aW9uLlxuICogQG1ldGhvZCBzaGFyZVJlcGxheVxuICogQG93bmVyIE9ic2VydmFibGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNoYXJlUmVwbGF5PFQ+KGNvbmZpZzogU2hhcmVSZXBsYXlDb25maWcpOiBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb248VD47XG5leHBvcnQgZnVuY3Rpb24gc2hhcmVSZXBsYXk8VD4oYnVmZmVyU2l6ZT86IG51bWJlciwgd2luZG93VGltZT86IG51bWJlciwgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbjxUPjtcbmV4cG9ydCBmdW5jdGlvbiBzaGFyZVJlcGxheTxUPihcbiAgY29uZmlnT3JCdWZmZXJTaXplPzogU2hhcmVSZXBsYXlDb25maWcgfCBudW1iZXIsXG4gIHdpbmRvd1RpbWU/OiBudW1iZXIsXG4gIHNjaGVkdWxlcj86IFNjaGVkdWxlckxpa2Vcbik6IE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbjxUPiB7XG4gIGxldCBjb25maWc6IFNoYXJlUmVwbGF5Q29uZmlnO1xuICBpZiAoY29uZmlnT3JCdWZmZXJTaXplICYmIHR5cGVvZiBjb25maWdPckJ1ZmZlclNpemUgPT09ICdvYmplY3QnKSB7XG4gICAgY29uZmlnID0gY29uZmlnT3JCdWZmZXJTaXplIGFzIFNoYXJlUmVwbGF5Q29uZmlnO1xuICB9IGVsc2Uge1xuICAgIGNvbmZpZyA9IHtcbiAgICAgIGJ1ZmZlclNpemU6IGNvbmZpZ09yQnVmZmVyU2l6ZSBhcyBudW1iZXIgfCB1bmRlZmluZWQsXG4gICAgICB3aW5kb3dUaW1lLFxuICAgICAgcmVmQ291bnQ6IGZhbHNlLFxuICAgICAgc2NoZWR1bGVyXG4gICAgfTtcbiAgfVxuICByZXR1cm4gKHNvdXJjZTogT2JzZXJ2YWJsZTxUPikgPT4gc291cmNlLmxpZnQoc2hhcmVSZXBsYXlPcGVyYXRvcihjb25maWcpKTtcbn1cblxuZnVuY3Rpb24gc2hhcmVSZXBsYXlPcGVyYXRvcjxUPih7XG4gIGJ1ZmZlclNpemUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksXG4gIHdpbmRvd1RpbWUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksXG4gIHJlZkNvdW50OiB1c2VSZWZDb3VudCxcbiAgc2NoZWR1bGVyXG59OiBTaGFyZVJlcGxheUNvbmZpZykge1xuICBsZXQgc3ViamVjdDogUmVwbGF5U3ViamVjdDxUPiB8IHVuZGVmaW5lZDtcbiAgbGV0IHJlZkNvdW50ID0gMDtcbiAgbGV0IHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uIHwgdW5kZWZpbmVkO1xuICBsZXQgaGFzRXJyb3IgPSBmYWxzZTtcbiAgbGV0IGlzQ29tcGxldGUgPSBmYWxzZTtcblxuICByZXR1cm4gZnVuY3Rpb24gc2hhcmVSZXBsYXlPcGVyYXRpb24odGhpczogU3Vic2NyaWJlcjxUPiwgc291cmNlOiBPYnNlcnZhYmxlPFQ+KSB7XG4gICAgcmVmQ291bnQrKztcbiAgICBpZiAoIXN1YmplY3QgfHwgaGFzRXJyb3IpIHtcbiAgICAgIGhhc0Vycm9yID0gZmFsc2U7XG4gICAgICBzdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8VD4oYnVmZmVyU2l6ZSwgd2luZG93VGltZSwgc2NoZWR1bGVyKTtcbiAgICAgIHN1YnNjcmlwdGlvbiA9IHNvdXJjZS5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0KHZhbHVlKSB7IHN1YmplY3QubmV4dCh2YWx1ZSk7IH0sXG4gICAgICAgIGVycm9yKGVycikge1xuICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgICAgICBzdWJqZWN0LmVycm9yKGVycik7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBsZXRlKCkge1xuICAgICAgICAgIGlzQ29tcGxldGUgPSB0cnVlO1xuICAgICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGlubmVyU3ViID0gc3ViamVjdC5zdWJzY3JpYmUodGhpcyk7XG4gICAgdGhpcy5hZGQoKCkgPT4ge1xuICAgICAgcmVmQ291bnQtLTtcbiAgICAgIGlubmVyU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICBpZiAoc3Vic2NyaXB0aW9uICYmICFpc0NvbXBsZXRlICYmIHVzZVJlZkNvdW50ICYmIHJlZkNvdW50ID09PSAwKSB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICBzdWJzY3JpcHRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIHN1YmplY3QgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG59XG4iXX0=