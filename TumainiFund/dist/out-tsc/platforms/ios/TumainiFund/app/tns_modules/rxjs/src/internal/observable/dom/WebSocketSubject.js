import { Subject, AnonymousSubject } from '../../Subject';
import { Subscriber } from '../../Subscriber';
import { Observable } from '../../Observable';
import { Subscription } from '../../Subscription';
import { ReplaySubject } from '../../ReplaySubject';
const DEFAULT_WEBSOCKET_CONFIG = {
    url: '',
    deserializer: (e) => JSON.parse(e.data),
    serializer: (value) => JSON.stringify(value),
};
const WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';
export class WebSocketSubject extends AnonymousSubject {
    constructor(urlConfigOrSource, destination) {
        super();
        if (urlConfigOrSource instanceof Observable) {
            this.destination = destination;
            this.source = urlConfigOrSource;
        }
        else {
            const config = this._config = Object.assign({}, DEFAULT_WEBSOCKET_CONFIG);
            this._output = new Subject();
            if (typeof urlConfigOrSource === 'string') {
                config.url = urlConfigOrSource;
            }
            else {
                for (let key in urlConfigOrSource) {
                    if (urlConfigOrSource.hasOwnProperty(key)) {
                        config[key] = urlConfigOrSource[key];
                    }
                }
            }
            if (!config.WebSocketCtor && WebSocket) {
                config.WebSocketCtor = WebSocket;
            }
            else if (!config.WebSocketCtor) {
                throw new Error('no WebSocket constructor can be found');
            }
            this.destination = new ReplaySubject();
        }
    }
    lift(operator) {
        const sock = new WebSocketSubject(this._config, this.destination);
        sock.operator = operator;
        sock.source = this;
        return sock;
    }
    _resetState() {
        this._socket = null;
        if (!this.source) {
            this.destination = new ReplaySubject();
        }
        this._output = new Subject();
    }
    /**
     * Creates an {@link Observable}, that when subscribed to, sends a message,
     * defined by the `subMsg` function, to the server over the socket to begin a
     * subscription to data over that socket. Once data arrives, the
     * `messageFilter` argument will be used to select the appropriate data for
     * the resulting Observable. When teardown occurs, either due to
     * unsubscription, completion or error, a message defined by the `unsubMsg`
     * argument will be send to the server over the WebSocketSubject.
     *
     * @param subMsg A function to generate the subscription message to be sent to
     * the server. This will still be processed by the serializer in the
     * WebSocketSubject's config. (Which defaults to JSON serialization)
     * @param unsubMsg A function to generate the unsubscription message to be
     * sent to the server at teardown. This will still be processed by the
     * serializer in the WebSocketSubject's config.
     * @param messageFilter A predicate for selecting the appropriate messages
     * from the server for the output stream.
     */
    multiplex(subMsg, unsubMsg, messageFilter) {
        const self = this;
        return new Observable((observer) => {
            try {
                self.next(subMsg());
            }
            catch (err) {
                observer.error(err);
            }
            const subscription = self.subscribe(x => {
                try {
                    if (messageFilter(x)) {
                        observer.next(x);
                    }
                }
                catch (err) {
                    observer.error(err);
                }
            }, err => observer.error(err), () => observer.complete());
            return () => {
                try {
                    self.next(unsubMsg());
                }
                catch (err) {
                    observer.error(err);
                }
                subscription.unsubscribe();
            };
        });
    }
    _connectSocket() {
        const { WebSocketCtor, protocol, url, binaryType } = this._config;
        const observer = this._output;
        let socket = null;
        try {
            socket = protocol ?
                new WebSocketCtor(url, protocol) :
                new WebSocketCtor(url);
            this._socket = socket;
            if (binaryType) {
                this._socket.binaryType = binaryType;
            }
        }
        catch (e) {
            observer.error(e);
            return;
        }
        const subscription = new Subscription(() => {
            this._socket = null;
            if (socket && socket.readyState === 1) {
                socket.close();
            }
        });
        socket.onopen = (e) => {
            const { _socket } = this;
            if (!_socket) {
                socket.close();
                this._resetState();
                return;
            }
            const { openObserver } = this._config;
            if (openObserver) {
                openObserver.next(e);
            }
            const queue = this.destination;
            this.destination = Subscriber.create((x) => {
                if (socket.readyState === 1) {
                    try {
                        const { serializer } = this._config;
                        socket.send(serializer(x));
                    }
                    catch (e) {
                        this.destination.error(e);
                    }
                }
            }, (e) => {
                const { closingObserver } = this._config;
                if (closingObserver) {
                    closingObserver.next(undefined);
                }
                if (e && e.code) {
                    socket.close(e.code, e.reason);
                }
                else {
                    observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));
                }
                this._resetState();
            }, () => {
                const { closingObserver } = this._config;
                if (closingObserver) {
                    closingObserver.next(undefined);
                }
                socket.close();
                this._resetState();
            });
            if (queue && queue instanceof ReplaySubject) {
                subscription.add(queue.subscribe(this.destination));
            }
        };
        socket.onerror = (e) => {
            this._resetState();
            observer.error(e);
        };
        socket.onclose = (e) => {
            this._resetState();
            const { closeObserver } = this._config;
            if (closeObserver) {
                closeObserver.next(e);
            }
            if (e.wasClean) {
                observer.complete();
            }
            else {
                observer.error(e);
            }
        };
        socket.onmessage = (e) => {
            try {
                const { deserializer } = this._config;
                observer.next(deserializer(e));
            }
            catch (err) {
                observer.error(err);
            }
        };
    }
    /** @deprecated This is an internal implementation detail, do not use. */
    _subscribe(subscriber) {
        const { source } = this;
        if (source) {
            return source.subscribe(subscriber);
        }
        if (!this._socket) {
            this._connectSocket();
        }
        this._output.subscribe(subscriber);
        subscriber.add(() => {
            const { _socket } = this;
            if (this._output.observers.length === 0) {
                if (_socket && _socket.readyState === 1) {
                    _socket.close();
                }
                this._resetState();
            }
        });
        return subscriber;
    }
    unsubscribe() {
        const { _socket } = this;
        if (_socket && _socket.readyState === 1) {
            _socket.close();
        }
        this._resetState();
        super.unsubscribe();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0U3ViamVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BsYXRmb3Jtcy9pb3MvVHVtYWluaUZ1bmQvYXBwL3Ruc19tb2R1bGVzL3J4anMvc3JjL2ludGVybmFsL29ic2VydmFibGUvZG9tL1dlYlNvY2tldFN1YmplY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFzSXBELE1BQU0sd0JBQXdCLEdBQWdDO0lBQzVELEdBQUcsRUFBRSxFQUFFO0lBQ1AsWUFBWSxFQUFFLENBQUMsQ0FBZSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDckQsVUFBVSxFQUFFLENBQUMsS0FBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztDQUNsRCxDQUFDO0FBRUYsTUFBTSxxQ0FBcUMsR0FDekMsbUlBQW1JLENBQUM7QUFJdEksTUFBTSxPQUFPLGdCQUFvQixTQUFRLGdCQUFtQjtJQVMxRCxZQUFZLGlCQUFxRSxFQUFFLFdBQXlCO1FBQzFHLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxpQkFBaUIsWUFBWSxVQUFVLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7WUFDL0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBa0MsQ0FBQztTQUNsRDthQUFNO1lBQ0ws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V0FBVyxFQUFFLENBQUM7UUFDbkIsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3RCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIEFub255bW91c1N1YmplY3QgfSBmcm9tICcuLi8uLi9TdWJqZWN0JztcbmltcG9ydCB7IFN1YnNjcmliZXIgfSBmcm9tICcuLi8uLi9TdWJzY3JpYmVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi8uLi9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJy4uLy4uL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBPcGVyYXRvciB9IGZyb20gJy4uLy4uL09wZXJhdG9yJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICcuLi8uLi9SZXBsYXlTdWJqZWN0JztcbmltcG9ydCB7IE9ic2VydmVyLCBOZXh0T2JzZXJ2ZXIgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbi8qKlxuICogV2ViU29ja2V0U3ViamVjdENvbmZpZyBpcyBhIHBsYWluIE9iamVjdCB0aGF0IGFsbG93cyB1cyB0byBtYWtlIG91clxuICogd2ViU29ja2V0IGNvbmZpZ3VyYWJsZS5cbiAqXG4gKiA8c3BhbiBjbGFzcz1cImluZm9ybWFsXCI+UHJvdmlkZXMgZmxleGliaWxpdHkgdG8ge0BsaW5rIHdlYlNvY2tldH08L3NwYW4+XG4gKlxuICogSXQgZGVmaW5lcyBhIHNldCBvZiBwcm9wZXJ0aWVzIHRvIHByb3ZpZGUgY3VzdG9tIGJlaGF2aW9yIGluIHNwZWNpZmljXG4gKiBtb21lbnRzIG9mIHRoZSBzb2NrZXQncyBsaWZlY3ljbGUuIFdoZW4gdGhlIGNvbm5lY3Rpb24gb3BlbnMgd2UgY2FuXG4gKiB1c2UgYG9wZW5PYnNlcnZlcmAsIHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgY2xvc2VkIGBjbG9zZU9ic2VydmVyYCwgaWYgd2VcbiAqIGFyZSBpbnRlcmVzdGVkIGluIGxpc3RlbmluZyBmb3IgZGF0YSBjb21taW5nIGZyb20gc2VydmVyOiBgZGVzZXJpYWxpemVyYCxcbiAqIHdoaWNoIGFsbG93cyB1cyB0byBjdXN0b21pemUgdGhlIGRlc2VyaWFsaXphdGlvbiBzdHJhdGVneSBvZiBkYXRhIGJlZm9yZSBwYXNzaW5nIGl0XG4gKiB0byB0aGUgc29ja2V0IGNsaWVudC4gQnkgZGVmYXVsdCBgZGVzZXJpYWxpemVyYCBpcyBnb2luZyB0byBhcHBseSBgSlNPTi5wYXJzZWAgdG8gZWFjaCBtZXNzYWdlIGNvbW1pbmdcbiAqIGZyb20gdGhlIFNlcnZlci5cbiAqXG4gKiAjIyBFeGFtcGxlXG4gKiAqKmRlc2VyaWFsaXplcioqLCB0aGUgZGVmYXVsdCBmb3IgdGhpcyBwcm9wZXJ0eSBpcyBgSlNPTi5wYXJzZWAgYnV0IHNpbmNlIHRoZXJlIGFyZSBqdXN0IHR3byBvcHRpb25zXG4gKiBmb3IgaW5jb21taW5nIGRhdGEsIGVpdGhlciBiZSB0ZXh0IG9yIGJpbmFyeWRhdGEuIFdlIGNhbiBhcHBseSBhIGN1c3RvbSBkZXNlcmlhbGl6YXRpb24gc3RyYXRlZ3lcbiAqIG9yIGp1c3Qgc2ltcGx5IHNraXAgdGhlIGRlZmF1bHQgYmVoYXZpb3VyLlxuICogYGBgdHNcbiAqIGltcG9ydCB7IHdlYlNvY2tldCB9IGZyb20gJ3J4anMvd2ViU29ja2V0JztcbiAqXG4gKiBjb25zdCB3c1N1YmplY3QgPSB3ZWJTb2NrZXQoe1xuICogICAgIHVybDogJ3dzOi8vbG9jYWxob3N0OjgwODEnLFxuICogLy9BcHBseSBhbnkgdHJhbnNmb3JtYXRpb24gb2YgeW91ciBjaG9pY2UuXG4gKiAgICAgZGVzZXJpYWxpemVyOiAoe2RhdGF9KSA9PiBkYXRhXG4gKiB9KTtcbiAqXG4gKiB3c1N1YmplY3Quc3Vic2NyaWJlKGNvbnNvbGUubG9nKTtcbiAqXG4gKiAvLyBMZXQncyBzdXBwb3NlIHdlIGhhdmUgdGhpcyBvbiB0aGUgU2VydmVyOiB3cy5zZW5kKFwiVGhpcyBpcyBhIG1zZyBmcm9tIHRoZSBzZXJ2ZXJcIilcbiAqIC8vb3V0cHV0XG4gKiAvL1xuICogLy8gVGhpcyBpcyBhIG1zZyBmcm9tIHRoZSBzZXJ2ZXJcbiAqIGBgYFxuICpcbiAqICoqc2VyaWFsaXplcioqIGFsbG93cyB1cyB0b20gYXBwbHkgY3VzdG9tIHNlcmlhbGl6YXRpb24gc3RyYXRlZ3kgYnV0IGZvciB0aGUgb3V0Z29pbmcgbWVzc2FnZXNcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCc7XG4gKlxuICogY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAqICAgICB1cmw6ICd3czovL2xvY2FsaG9zdDo4MDgxJyxcbiAqIC8vQXBwbHkgYW55IHRyYW5zZm9ybWF0aW9uIG9mIHlvdXIgY2hvaWNlLlxuICogICAgIHNlcmlhbGl6ZXI6IG1zZyA9PiBKU09OLnN0cmluZ2lmeSh7Y2hhbm5lbDogXCJ3ZWJEZXZlbG9wbWVudFwiLCBtc2c6IG1zZ30pXG4gKiB9KTtcbiAqXG4gKiB3c1N1YmplY3Quc3Vic2NyaWJlKCgpID0+IHN1YmplY3QubmV4dChcIm1zZyB0byB0aGUgc2VydmVyXCIpKTtcbiAqXG4gKiAvLyBMZXQncyBzdXBwb3NlIHdlIGhhdmUgdGhpcyBvbiB0aGUgU2VydmVyOiB3cy5zZW5kKFwiVGhpcyBpcyBhIG1zZyBmcm9tIHRoZSBzZXJ2ZXJcIilcbiAqIC8vb3V0cHV0XG4gKiAvL1xuICogLy8ge1wiY2hhbm5lbFwiOlwid2ViRGV2ZWxvcG1lbnRcIixcIm1zZ1wiOlwibXNnIHRvIHRoZSBzZXJ2ZXJcIn1cbiAqIGBgYFxuICpcbiAqICoqY2xvc2VPYnNlcnZlcioqIGFsbG93cyB1cyB0byBzZXQgYSBjdXN0b20gZXJyb3Igd2hlbiBhbiBlcnJvciByYWlzZSB1cC5cbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCc7XG4gKlxuICogY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAqICAgICB1cmw6ICd3czovL2xvY2FsaG9zdDo4MDgxJyxcbiAqICAgICBjbG9zZU9ic2VydmVyOiB7XG4gICAgICAgIG5leHQoY2xvc2VFdmVudCkge1xuICAgICAgICAgICAgY29uc3QgY3VzdG9tRXJyb3IgPSB7IGNvZGU6IDY2NjYsIHJlYXNvbjogXCJDdXN0b20gZXZpbCByZWFzb25cIiB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgY29kZTogJHtjdXN0b21FcnJvci5jb2RlfSwgcmVhc29uOiAke2N1c3RvbUVycm9yLnJlYXNvbn1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAqIH0pO1xuICpcbiAqIC8vb3V0cHV0XG4gKiAvLyBjb2RlOiA2NjY2LCByZWFzb246IEN1c3RvbSBldmlsIHJlYXNvblxuICogYGBgXG4gKlxuICogKipvcGVuT2JzZXJ2ZXIqKiwgTGV0J3Mgc2F5IHdlIG5lZWQgdG8gbWFrZSBzb21lIGtpbmQgb2YgaW5pdCB0YXNrIGJlZm9yZSBzZW5kaW5nL3JlY2VpdmluZyBtc2dzIHRvIHRoZVxuICogd2ViU29ja2V0IG9yIHNlbmRpbmcgbm90aWZpY2F0aW9uIHRoYXQgdGhlIGNvbm5lY3Rpb24gd2FzIHN1Y2Nlc3NmdWwsIHRoaXMgaXMgd2hlblxuICogb3Blbk9ic2VydmVyIGlzIHVzZWZ1bGwgZm9yLlxuICogYGBgdHNcbiAqIGltcG9ydCB7IHdlYlNvY2tldCB9IGZyb20gJ3J4anMvd2ViU29ja2V0JztcbiAqXG4gKiBjb25zdCB3c1N1YmplY3QgPSB3ZWJTb2NrZXQoe1xuICogICAgIHVybDogJ3dzOi8vbG9jYWxob3N0OjgwODEnLFxuICogICAgIG9wZW5PYnNlcnZlcjoge1xuICogICAgICAgICBuZXh0OiAoKSA9PiB7XG4gKiAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmV0aW9uIG9rJyk7XG4gKiAgICAgICAgIH1cbiAqICAgICB9LFxuICogfSk7XG4gKlxuICogLy9vdXRwdXRcbiAqIC8vIGNvbm5ldGlvbiBva2BcbiAqIGBgYFxuICogKi9cblxuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnPFQ+IHtcbiAgLyoqIFRoZSB1cmwgb2YgdGhlIHNvY2tldCBzZXJ2ZXIgdG8gY29ubmVjdCB0byAqL1xuICB1cmw6IHN0cmluZztcbiAgLyoqIFRoZSBwcm90b2NvbCB0byB1c2UgdG8gY29ubmVjdCAqL1xuICBwcm90b2NvbD86IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gIC8qKiBAZGVwcmVjYXRlZCB1c2Uge0BsaW5rIGRlc2VyaWFsaXplcn0gKi9cbiAgcmVzdWx0U2VsZWN0b3I/OiAoZTogTWVzc2FnZUV2ZW50KSA9PiBUO1xuICAvKipcbiAgICogQSBzZXJpYWxpemVyIHVzZWQgdG8gY3JlYXRlIG1lc3NhZ2VzIGZyb20gcGFzc2VkIHZhbHVlcyBiZWZvcmUgdGhlXG4gICAqIG1lc3NhZ2VzIGFyZSBzZW50IHRvIHRoZSBzZXJ2ZXIuIERlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5LlxuICAgKi9cbiAgc2VyaWFsaXplcj86ICh2YWx1ZTogVCkgPT4gV2ViU29ja2V0TWVzc2FnZTtcbiAgLyoqXG4gICAqIEEgZGVzZXJpYWxpemVyIHVzZWQgZm9yIG1lc3NhZ2VzIGFycml2aW5nIG9uIHRoZSBzb2NrZXQgZnJvbSB0aGVcbiAgICogc2VydmVyLiBEZWZhdWx0cyB0byBKU09OLnBhcnNlLlxuICAgKi9cbiAgZGVzZXJpYWxpemVyPzogKGU6IE1lc3NhZ2VFdmVudCkgPT4gVDtcbiAgLyoqXG4gICAqIEFuIE9ic2VydmVyIHRoYXQgd2F0Y2hlcyB3aGVuIG9wZW4gZXZlbnRzIG9jY3VyIG9uIHRoZSB1bmRlcmx5aW5nIHdlYiBzb2NrZXQuXG4gICAqL1xuICBvcGVuT2JzZXJ2ZXI/OiBOZXh0T2JzZXJ2ZXI8RXZlbnQ+O1xuICAvKipcbiAgICogQW4gT2JzZXJ2ZXIgdGhhbiB3YXRjaGVzIHdoZW4gY2xvc2UgZXZlbnRzIG9jY3VyIG9uIHRoZSB1bmRlcmx5aW5nIHdlYlNvY2tldFxuICAgKi9cbiAgY2xvc2VPYnNlcnZlcj86IE5leHRPYnNlcnZlcjxDbG9zZUV2ZW50PjtcbiAgLyoqXG4gICAqIEFuIE9ic2VydmVyIHRoYXQgd2F0Y2hlcyB3aGVuIGEgY2xvc2UgaXMgYWJvdXQgdG8gb2NjdXIgZHVlIHRvXG4gICAqIHVuc3Vic2NyaXB0aW9uLlxuICAgKi9cbiAgY2xvc2luZ09ic2VydmVyPzogTmV4dE9ic2VydmVyPHZvaWQ+O1xuICAvKipcbiAgICogQSBXZWJTb2NrZXQgY29uc3RydWN0b3IgdG8gdXNlLiBUaGlzIGlzIHVzZWZ1bCBmb3Igc2l0dWF0aW9ucyBsaWtlIHVzaW5nIGFcbiAgICogV2ViU29ja2V0IGltcGwgaW4gTm9kZSAoV2ViU29ja2V0IGlzIGEgRE9NIEFQSSksIG9yIGZvciBtb2NraW5nIGEgV2ViU29ja2V0XG4gICAqIGZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAqL1xuICBXZWJTb2NrZXRDdG9yPzogeyBuZXcodXJsOiBzdHJpbmcsIHByb3RvY29scz86IHN0cmluZ3xzdHJpbmdbXSk6IFdlYlNvY2tldCB9O1xuICAvKiogU2V0cyB0aGUgYGJpbmFyeVR5cGVgIHByb3BlcnR5IG9mIHRoZSB1bmRlcmx5aW5nIFdlYlNvY2tldC4gKi9cbiAgYmluYXJ5VHlwZT86ICdibG9iJyB8ICdhcnJheWJ1ZmZlcic7XG59XG5cbmNvbnN0IERFRkFVTFRfV0VCU09DS0VUX0NPTkZJRzogV2ViU29ja2V0U3ViamVjdENvbmZpZzxhbnk+ID0ge1xuICB1cmw6ICcnLFxuICBkZXNlcmlhbGl6ZXI6IChlOiBNZXNzYWdlRXZlbnQpID0+IEpTT04ucGFyc2UoZS5kYXRhKSxcbiAgc2VyaWFsaXplcjogKHZhbHVlOiBhbnkpID0+IEpTT04uc3RyaW5naWZ5KHZhbHVlKSxcbn07XG5cbmNvbnN0IFdFQlNPQ0tFVFNVQkpFQ1RfSU5WQUxJRF9FUlJPUl9PQkpFQ1QgPVxuICAnV2ViU29ja2V0U3ViamVjdC5lcnJvciBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIG9iamVjdCB3aXRoIGFuIGVycm9yIGNvZGUsIGFuZCBhbiBvcHRpb25hbCByZWFzb246IHsgY29kZTogbnVtYmVyLCByZWFzb246IHN0cmluZyB9JztcblxuZXhwb3J0IHR5cGUgV2ViU29ja2V0TWVzc2FnZSA9IHN0cmluZyB8IEFycmF5QnVmZmVyIHwgQmxvYiB8IEFycmF5QnVmZmVyVmlldztcblxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFN1YmplY3Q8VD4gZXh0ZW5kcyBBbm9ueW1vdXNTdWJqZWN0PFQ+IHtcblxuICBwcml2YXRlIF9jb25maWc6IFdlYlNvY2tldFN1YmplY3RDb25maWc8VD47XG5cbiAgLyoqIEBkZXByZWNhdGVkIFRoaXMgaXMgYW4gaW50ZXJuYWwgaW1wbGVtZW50YXRpb24gZGV0YWlsLCBkbyBub3QgdXNlLiAqL1xuICBfb3V0cHV0OiBTdWJqZWN0PFQ+O1xuXG4gIHByaXZhdGUgX3NvY2tldDogV2ViU29ja2V0O1xuXG4gIGNvbnN0cnVjdG9yKHVybENvbmZpZ09yU291cmNlOiBzdHJpbmcgfCBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnPFQ+IHwgT2JzZXJ2YWJsZTxUPiwgZGVzdGluYXRpb24/OiBPYnNlcnZlcjxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKHVybENvbmZpZ09yU291cmNlIGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgdGhpcy5kZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uO1xuICAgICAgdGhpcy5zb3VyY2UgPSB1cmxDb25maWdPclNvdXJjZSBhcyBPYnNlcnZhYmxlPFQ+O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjb25maWcgPSB0aGlzLl9jb25maWcgPSB7IC4uLkRFRkFVTFRfV0VCU09DS0VUX0NPTkZJRyB9O1xuICAgICAgdGhpcy5fb3V0cHV0ID0gbmV3IFN1YmplY3Q8VD4oKTtcbiAgICAgIGlmICh0eXBlb2YgdXJsQ29uZmlnT3JTb3VyY2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbmZpZy51cmwgPSB1cmxDb25maWdPclNvdXJjZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAobGV0IGtleSBpbiB1cmxDb25maWdPclNvdXJjZSkge1xuICAgICAgICAgIGlmICh1cmxDb25maWdPclNvdXJjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICBjb25maWdba2V5XSA9IHVybENvbmZpZ09yU291cmNlW2tleV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghY29uZmlnLldlYlNvY2tldEN0b3IgJiYgV2ViU29ja2V0KSB7XG4gICAgICAgIGNvbmZpZy5XZWJTb2NrZXRDdG9yID0gV2ViU29ja2V0O1xuICAgICAgfSBlbHNlIGlmICghY29uZmlnLldlYlNvY2tldEN0b3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdubyBXZWJTb2NrZXQgY29uc3RydWN0b3IgY2FuIGJlIGZvdW5kJyk7XG4gICAgICB9XG4gICAgICB0aGlzLmRlc3RpbmF0aW9uID0gbmV3IFJlcGxheVN1YmplY3QoKTtcbiAgICB9XG4gIH1cblxuICBsaWZ0PFI+KG9wZXJhdG9yOiBPcGVyYXRvcjxULCBSPik6IFdlYlNvY2tldFN1YmplY3Q8Uj4ge1xuICAgIGNvbnN0IHNvY2sgPSBuZXcgV2ViU29ja2V0U3ViamVjdDxSPih0aGlzLl9jb25maWcgYXMgV2ViU29ja2V0U3ViamVjdENvbmZpZzxhbnk+LCA8YW55PiB0aGlzLmRlc3RpbmF0aW9uKTtcbiAgICBzb2NrLm9wZXJhdG9yID0gb3BlcmF0b3I7XG4gICAgc29jay5zb3VyY2UgPSB0aGlzO1xuICAgIHJldHVybiBzb2NrO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzZXRTdGF0ZSgpIHtcbiAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgIGlmICghdGhpcy5zb3VyY2UpIHtcbiAgICAgIHRoaXMuZGVzdGluYXRpb24gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuICAgIH1cbiAgICB0aGlzLl9vdXRwdXQgPSBuZXcgU3ViamVjdDxUPigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4ge0BsaW5rIE9ic2VydmFibGV9LCB0aGF0IHdoZW4gc3Vic2NyaWJlZCB0bywgc2VuZHMgYSBtZXNzYWdlLFxuICAgKiBkZWZpbmVkIGJ5IHRoZSBgc3ViTXNnYCBmdW5jdGlvbiwgdG8gdGhlIHNlcnZlciBvdmVyIHRoZSBzb2NrZXQgdG8gYmVnaW4gYVxuICAgKiBzdWJzY3JpcHRpb24gdG8gZGF0YSBvdmVyIHRoYXQgc29ja2V0LiBPbmNlIGRhdGEgYXJyaXZlcywgdGhlXG4gICAqIGBtZXNzYWdlRmlsdGVyYCBhcmd1bWVudCB3aWxsIGJlIHVzZWQgdG8gc2VsZWN0IHRoZSBhcHByb3ByaWF0ZSBkYXRhIGZvclxuICAgKiB0aGUgcmVzdWx0aW5nIE9ic2VydmFibGUuIFdoZW4gdGVhcmRvd24gb2NjdXJzLCBlaXRoZXIgZHVlIHRvXG4gICAqIHVuc3Vic2NyaXB0aW9uLCBjb21wbGV0aW9uIG9yIGVycm9yLCBhIG1lc3NhZ2UgZGVmaW5lZCBieSB0aGUgYHVuc3ViTXNnYFxuICAgKiBhcmd1bWVudCB3aWxsIGJlIHNlbmQgdG8gdGhlIHNlcnZlciBvdmVyIHRoZSBXZWJTb2NrZXRTdWJqZWN0LlxuICAgKlxuICAgKiBAcGFyYW0gc3ViTXNnIEEgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIHN1YnNjcmlwdGlvbiBtZXNzYWdlIHRvIGJlIHNlbnQgdG9cbiAgICogdGhlIHNlcnZlci4gVGhpcyB3aWxsIHN0aWxsIGJlIHByb2Nlc3NlZCBieSB0aGUgc2VyaWFsaXplciBpbiB0aGVcbiAgICogV2ViU29ja2V0U3ViamVjdCdzIGNvbmZpZy4gKFdoaWNoIGRlZmF1bHRzIHRvIEpTT04gc2VyaWFsaXphdGlvbilcbiAgICogQHBhcmFtIHVuc3ViTXNnIEEgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIHVuc3Vic2NyaXB0aW9uIG1lc3NhZ2UgdG8gYmVcbiAgICogc2VudCB0byB0aGUgc2VydmVyIGF0IHRlYXJkb3duLiBUaGlzIHdpbGwgc3RpbGwgYmUgcHJvY2Vzc2VkIGJ5IHRoZVxuICAgKiBzZXJpYWxpemVyIGluIHRoZSBXZWJTb2NrZXRTdWJqZWN0J3MgY29uZmlnLlxuICAgKiBAcGFyYW0gbWVzc2FnZUZpbHRlciBBIHByZWRpY2F0ZSBmb3Igc2VsZWN0aW5nIHRoZSBhcHByb3ByaWF0ZSBtZXNzYWdlc1xuICAgKiBmcm9tIHRoZSBzZXJ2ZXIgZm9yIHRoZSBvdXRwdXQgc3RyZWFtLlxuICAgKi9cbiAgbXVsdGlwbGV4KHN1Yk1zZzogKCkgPT4gYW55LCB1bnN1Yk1zZzogKCkgPT4gYW55LCBtZXNzYWdlRmlsdGVyOiAodmFsdWU6IFQpID0+IGJvb2xlYW4pIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBPYnNlcnZlcjxhbnk+KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBzZWxmLm5leHQoc3ViTXNnKCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHNlbGYuc3Vic2NyaWJlKHggPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChtZXNzYWdlRmlsdGVyKHgpKSB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KHgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgICAgZXJyID0+IG9ic2VydmVyLmVycm9yKGVyciksXG4gICAgICAgICgpID0+IG9ic2VydmVyLmNvbXBsZXRlKCkpO1xuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHNlbGYubmV4dCh1bnN1Yk1zZygpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9jb25uZWN0U29ja2V0KCkge1xuICAgIGNvbnN0IHsgV2ViU29ja2V0Q3RvciwgcHJvdG9jb2wsIHVybCwgYmluYXJ5VHlwZSB9ID0gdGhpcy5fY29uZmlnO1xuICAgIGNvbnN0IG9ic2VydmVyID0gdGhpcy5fb3V0cHV0O1xuXG4gICAgbGV0IHNvY2tldDogV2ViU29ja2V0ID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgc29ja2V0ID0gcHJvdG9jb2wgP1xuICAgICAgICBuZXcgV2ViU29ja2V0Q3Rvcih1cmwsIHByb3RvY29sKSA6XG4gICAgICAgIG5ldyBXZWJTb2NrZXRDdG9yKHVybCk7XG4gICAgICB0aGlzLl9zb2NrZXQgPSBzb2NrZXQ7XG4gICAgICBpZiAoYmluYXJ5VHlwZSkge1xuICAgICAgICB0aGlzLl9zb2NrZXQuYmluYXJ5VHlwZSA9IGJpbmFyeVR5cGU7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IoZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigoKSA9PiB7XG4gICAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgICAgaWYgKHNvY2tldCAmJiBzb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgICBzb2NrZXQuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHNvY2tldC5vbm9wZW4gPSAoZTogRXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHsgX3NvY2tldCB9ID0gdGhpcztcbiAgICAgIGlmICghX3NvY2tldCkge1xuICAgICAgICBzb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB7IG9wZW5PYnNlcnZlciB9ID0gdGhpcy5fY29uZmlnO1xuICAgICAgaWYgKG9wZW5PYnNlcnZlcikge1xuICAgICAgICBvcGVuT2JzZXJ2ZXIubmV4dChlKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcXVldWUgPSB0aGlzLmRlc3RpbmF0aW9uO1xuXG4gICAgICB0aGlzLmRlc3RpbmF0aW9uID0gU3Vic2NyaWJlci5jcmVhdGU8VD4oXG4gICAgICAgICh4KSA9PiB7XG4gICAgICAgICAgaWYgKHNvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCB7IHNlcmlhbGl6ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgICAgICAgICAgc29ja2V0LnNlbmQoc2VyaWFsaXplcih4KSk7XG4gICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXN0aW5hdGlvbi5lcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBjbG9zaW5nT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgICAgICBpZiAoY2xvc2luZ09ic2VydmVyKSB7XG4gICAgICAgICAgICBjbG9zaW5nT2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZSAmJiBlLmNvZGUpIHtcbiAgICAgICAgICAgIHNvY2tldC5jbG9zZShlLmNvZGUsIGUucmVhc29uKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IobmV3IFR5cGVFcnJvcihXRUJTT0NLRVRTVUJKRUNUX0lOVkFMSURfRVJST1JfT0JKRUNUKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgY2xvc2luZ09ic2VydmVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICAgICAgaWYgKGNsb3NpbmdPYnNlcnZlcikge1xuICAgICAgICAgICAgY2xvc2luZ09ic2VydmVyLm5leHQodW5kZWZpbmVkKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc29ja2V0LmNsb3NlKCk7XG4gICAgICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgICB9XG4gICAgICApIGFzIFN1YnNjcmliZXI8YW55PjtcblxuICAgICAgaWYgKHF1ZXVlICYmIHF1ZXVlIGluc3RhbmNlb2YgUmVwbGF5U3ViamVjdCkge1xuICAgICAgICBzdWJzY3JpcHRpb24uYWRkKCg8UmVwbGF5U3ViamVjdDxUPj5xdWV1ZSkuc3Vic2NyaWJlKHRoaXMuZGVzdGluYXRpb24pKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc29ja2V0Lm9uZXJyb3IgPSAoZTogRXZlbnQpID0+IHtcbiAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgIG9ic2VydmVyLmVycm9yKGUpO1xuICAgIH07XG5cbiAgICBzb2NrZXQub25jbG9zZSA9IChlOiBDbG9zZUV2ZW50KSA9PiB7XG4gICAgICB0aGlzLl9yZXNldFN0YXRlKCk7XG4gICAgICBjb25zdCB7IGNsb3NlT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgIGlmIChjbG9zZU9ic2VydmVyKSB7XG4gICAgICAgIGNsb3NlT2JzZXJ2ZXIubmV4dChlKTtcbiAgICAgIH1cbiAgICAgIGlmIChlLndhc0NsZWFuKSB7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc29ja2V0Lm9ubWVzc2FnZSA9IChlOiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgZGVzZXJpYWxpemVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICAgIG9ic2VydmVyLm5leHQoZGVzZXJpYWxpemVyKGUpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICAvKiogQGRlcHJlY2F0ZWQgVGhpcyBpcyBhbiBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwsIGRvIG5vdCB1c2UuICovXG4gIF9zdWJzY3JpYmUoc3Vic2NyaWJlcjogU3Vic2NyaWJlcjxUPik6IFN1YnNjcmlwdGlvbiB7XG4gICAgY29uc3QgeyBzb3VyY2UgfSA9IHRoaXM7XG4gICAgaWYgKHNvdXJjZSkge1xuICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgfVxuICAgIGlmICghdGhpcy5fc29ja2V0KSB7XG4gICAgICB0aGlzLl9jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuICAgIHRoaXMuX291dHB1dC5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgc3Vic2NyaWJlci5hZGQoKCkgPT4ge1xuICAgICAgY29uc3QgeyBfc29ja2V0IH0gPSB0aGlzO1xuICAgICAgaWYgKHRoaXMuX291dHB1dC5vYnNlcnZlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGlmIChfc29ja2V0ICYmIF9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgICAgIF9zb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZXNldFN0YXRlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN1YnNjcmliZXI7XG4gIH1cblxuICB1bnN1YnNjcmliZSgpIHtcbiAgICBjb25zdCB7IF9zb2NrZXQgfSA9IHRoaXM7XG4gICAgaWYgKF9zb2NrZXQgJiYgX3NvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICBfc29ja2V0LmNsb3NlKCk7XG4gICAgfVxuICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICBzdXBlci51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=