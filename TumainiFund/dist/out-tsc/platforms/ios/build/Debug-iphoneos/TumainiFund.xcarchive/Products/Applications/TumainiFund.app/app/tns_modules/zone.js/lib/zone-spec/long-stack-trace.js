/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
/**
 * @fileoverview
 * @suppress {globalThis}
 */
const NEWLINE = '\n';
const IGNORE_FRAMES = {};
const creationTrace = '__creationTrace__';
const ERROR_TAG = 'STACKTRACE TRACKING';
const SEP_TAG = '__SEP_TAG__';
let sepTemplate = SEP_TAG + '@[native]';
class LongStackTrace {
    constructor() {
        this.error = getStacktrace();
        this.timestamp = new Date();
    }
}
function getStacktraceWithUncaughtError() {
    return new Error(ERROR_TAG);
}
function getStacktraceWithCaughtError() {
    try {
        throw getStacktraceWithUncaughtError();
    }
    catch (err) {
        return err;
    }
}
// Some implementations of exception handling don't create a stack trace if the exception
// isn't thrown, however it's faster not to actually throw the exception.
const error = getStacktraceWithUncaughtError();
const caughtError = getStacktraceWithCaughtError();
const getStacktrace = error.stack ?
    getStacktraceWithUncaughtError :
    (caughtError.stack ? getStacktraceWithCaughtError : getStacktraceWithUncaughtError);
function getFrames(error) {
    return error.stack ? error.stack.split(NEWLINE) : [];
}
function addErrorStack(lines, error) {
    let trace = getFrames(error);
    for (let i = 0; i < trace.length; i++) {
        const frame = trace[i];
        // Filter out the Frames which are part of stack capturing.
        if (!IGNORE_FRAMES.hasOwnProperty(frame)) {
            lines.push(trace[i]);
        }
    }
}
function renderLongStackTrace(frames, stack) {
    const longTrace = [stack ? stack.trim() : ''];
    if (frames) {
        let timestamp = new Date().getTime();
        for (let i = 0; i < frames.length; i++) {
            const traceFrames = frames[i];
            const lastTime = traceFrames.timestamp;
            let separator = `____________________Elapsed ${timestamp - lastTime.getTime()} ms; At: ${lastTime}`;
            separator = separator.replace(/[^\w\d]/g, '_');
            longTrace.push(sepTemplate.replace(SEP_TAG, separator));
            addErrorStack(longTrace, traceFrames.error);
            timestamp = lastTime.getTime();
        }
    }
    return longTrace.join(NEWLINE);
}
Zone['longStackTraceZoneSpec'] = {
    name: 'long-stack-trace',
    longStackTraceLimit: 10,
    // add a getLongStackTrace method in spec to
    // handle handled reject promise error.
    getLongStackTrace: function (error) {
        if (!error) {
            return undefined;
        }
        const trace = error[Zone.__symbol__('currentTaskTrace')];
        if (!trace) {
            return error.stack;
        }
        return renderLongStackTrace(trace, error.stack);
    },
    onScheduleTask: function (parentZoneDelegate, currentZone, targetZone, task) {
        if (Error.stackTraceLimit > 0) {
            // if Error.stackTraceLimit is 0, means stack trace
            // is disabled, so we don't need to generate long stack trace
            // this will improve performance in some test(some test will
            // set stackTraceLimit to 0, https://github.com/angular/zone.js/issues/698
            const currentTask = Zone.currentTask;
            let trace = currentTask && currentTask.data && currentTask.data[creationTrace] || [];
            trace = [new LongStackTrace()].concat(trace);
            if (trace.length > this.longStackTraceLimit) {
                trace.length = this.longStackTraceLimit;
            }
            if (!task.data)
                task.data = {};
            task.data[creationTrace] = trace;
        }
        return parentZoneDelegate.scheduleTask(targetZone, task);
    },
    onHandleError: function (parentZoneDelegate, currentZone, targetZone, error) {
        if (Error.stackTraceLimit > 0) {
            // if Error.stackTraceLimit is 0, means stack trace
            // is disabled, so we don't need to generate long stack trace
            // this will improve performance in some test(some test will
            // set stackTraceLimit to 0, https://github.com/angular/zone.js/issues/698
            const parentTask = Zone.currentTask || error.task;
            if (error instanceof Error && parentTask) {
                const longStack = renderLongStackTrace(parentTask.data && parentTask.data[creationTrace], error.stack);
                try {
                    error.stack = error.longStack = longStack;
                }
                catch (err) {
                }
            }
        }
        return parentZoneDelegate.handleError(targetZone, error);
    }
};
function captureStackTraces(stackTraces, count) {
    if (count > 0) {
        stackTraces.push(getFrames((new LongStackTrace()).error));
        captureStackTraces(stackTraces, count - 1);
    }
}
function computeIgnoreFrames() {
    if (Error.stackTraceLimit <= 0) {
        return;
    }
    const frames = [];
    captureStackTraces(frames, 2);
    const frames1 = frames[0];
    const frames2 = frames[1];
    for (let i = 0; i < frames1.length; i++) {
        const frame1 = frames1[i];
        if (frame1.indexOf(ERROR_TAG) == -1) {
            let match = frame1.match(/^\s*at\s+/);
            if (match) {
                sepTemplate = match[0] + SEP_TAG + ' (http://localhost)';
                break;
            }
        }
    }
    for (let i = 0; i < frames1.length; i++) {
        const frame1 = frames1[i];
        const frame2 = frames2[i];
        if (frame1 === frame2) {
            IGNORE_FRAMES[frame1] = true;
        }
        else {
            break;
        }
    }
}
computeIgnoreFrames();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9uZy1zdGFjay10cmFjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BsYXRmb3Jtcy9pb3MvYnVpbGQvRGVidWctaXBob25lb3MvVHVtYWluaUZ1bmQueGNhcmNoaXZlL1Byb2R1Y3RzL0FwcGxpY2F0aW9ucy9UdW1haW5pRnVuZC5hcHAvYXBwL3Ruc19tb2R1bGVzL3pvbmUuanMvbGliL3pvbmUtc3BlYy9sb25nLXN0YWNrLXRyYWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUNIOzs7R0FHRztBQUVILE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQztBQUNyQixNQUFNLGFBQWEsR0FBd0IsRUFBRSxDQUFDO0FBQzlDLE1BQU0sYUFBYSxHQUFHLG1CQUFtQixDQUFDO0FBQzFDLE1BQU0sU0FBUyxHQUFHLHFCQUFxQixDQUFDO0FBQ3hDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQztBQUM5QixJQUFJLFdBQVcsR0FBVyxPQUFPLEdBQUcsV0FBVyxDQUFDO0FBRWhELE1BQU0sY0FBYztJQUFwQjtRQUNFLFVBQUssR0FBVSxhQUFhLEVBQUUsQ0FBQztRQUMvQixjQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDO0NBQUE7QUFFRCxTQUFTLDhCQUE4QjtJQUNyQyxPQUFPLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlCLENBQUM7QUFFRCxTQUFTLDRCQUE0QjtJQUNuQyxJQUFJO1FBQ0YsTUFBTSw4QkFBOEIsRUFBRSxDQUFDO0tBQ3hDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixPQUFPLEdBQUcsQ0FBQztLQUNaO0FBQ0gsQ0FBQztBQUVELHlGQUF5RjtBQUN6Rix5RUFBeUU7QUFDekUsTUFBTSxLQUFLLEdBQUcsOEJBQThCLEVBQUUsQ0FBQztBQUMvQyxNQUFNLFdBQVcsR0FBRyw0QkFBNEIs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QixJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDbkMsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN0QyxJQUFJLEtBQUssRUFBRTtnQkFDVCxXQUFXLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sR0FBRyxxQkFBcUIsQ0FBQztnQkFDekQsTUFBTTthQUNQO1NBQ0Y7S0FDRjtJQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUIsSUFBSSxNQUFNLEtBQUssTUFBTSxFQUFFO1lBQ3JCLGFBQWEsQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDOUI7YUFBTTtZQUNMLE1BQU07U0FDUDtLQUNGO0FBQ0gsQ0FBQztBQUNELG1CQUFtQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG4vKipcbiAqIEBmaWxlb3ZlcnZpZXdcbiAqIEBzdXBwcmVzcyB7Z2xvYmFsVGhpc31cbiAqL1xuXG5jb25zdCBORVdMSU5FID0gJ1xcbic7XG5jb25zdCBJR05PUkVfRlJBTUVTOiB7W2s6IHN0cmluZ106IHRydWV9ID0ge307XG5jb25zdCBjcmVhdGlvblRyYWNlID0gJ19fY3JlYXRpb25UcmFjZV9fJztcbmNvbnN0IEVSUk9SX1RBRyA9ICdTVEFDS1RSQUNFIFRSQUNLSU5HJztcbmNvbnN0IFNFUF9UQUcgPSAnX19TRVBfVEFHX18nO1xubGV0IHNlcFRlbXBsYXRlOiBzdHJpbmcgPSBTRVBfVEFHICsgJ0BbbmF0aXZlXSc7XG5cbmNsYXNzIExvbmdTdGFja1RyYWNlIHtcbiAgZXJyb3I6IEVycm9yID0gZ2V0U3RhY2t0cmFjZSgpO1xuICB0aW1lc3RhbXA6IERhdGUgPSBuZXcgRGF0ZSgpO1xufVxuXG5mdW5jdGlvbiBnZXRTdGFja3RyYWNlV2l0aFVuY2F1Z2h0RXJyb3IoKTogRXJyb3Ige1xuICByZXR1cm4gbmV3IEVycm9yKEVSUk9SX1RBRyk7XG59XG5cbmZ1bmN0aW9uIGdldFN0YWNrdHJhY2VXaXRoQ2F1Z2h0RXJyb3IoKTogRXJyb3Ige1xuICB0cnkge1xuICAgIHRocm93IGdldFN0YWNrdHJhY2VXaXRoVW5jYXVnaHRFcnJvcigpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gZXJyO1xuICB9XG59XG5cbi8vIFNvbWUgaW1wbGVtZW50YXRpb25zIG9mIGV4Y2VwdGlvbiBoYW5kbGluZyBkb24ndCBjcmVhdGUgYSBzdGFjayB0cmFjZSBpZiB0aGUgZXhjZXB0aW9uXG4vLyBpc24ndCB0aHJvd24sIGhvd2V2ZXIgaXQncyBmYXN0ZXIgbm90IHRvIGFjdHVhbGx5IHRocm93IHRoZSBleGNlcHRpb24uXG5jb25zdCBlcnJvciA9IGdldFN0YWNrdHJhY2VXaXRoVW5jYXVnaHRFcnJvcigpO1xuY29uc3QgY2F1Z2h0RXJyb3IgPSBnZXRTdGFja3RyYWNlV2l0aENhdWdodEVycm9yKCk7XG5jb25zdCBnZXRTdGFja3RyYWNlID0gZXJyb3Iuc3RhY2sgP1xuICAgIGdldFN0YWNrdHJhY2VXaXRoVW5jYXVnaHRFcnJvciA6XG4gICAgKGNhdWdodEVycm9yLnN0YWNrID8gZ2V0U3RhY2t0cmFjZVdpdGhDYXVnaHRFcnJvciA6IGdldFN0YWNrdHJhY2VXaXRoVW5jYXVnaHRFcnJvcik7XG5cbmZ1bmN0aW9uIGdldEZyYW1lcyhlcnJvcjogRXJyb3IpOiBzdHJpbmdbXSB7XG4gIHJldHVybiBlcnJvci5zdGFjayA/IGVycm9yLnN0YWNrLnNwbGl0KE5FV0xJTkUpIDogW107XG59XG5cbmZ1bmN0aW9uIGFkZEVycm9yU3RhY2sobGluZXM6IHN0cmluZ1tdLCBlcnJvcjogRXJyb3IpOiB2b2lkIHtcbiAgbGV0IHRyYWNlOiBzdHJpbmdbXSA9IGdldEZyYW1lcyhlcnJvcik7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdHJhY2UubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBmcmFtZSA9IHRyYWNlW2ldO1xuICAgIC8vIEZpbHRlciBvdXQgdGhlIEZyYW1lcyB3aGljaCBhcmUgcGFydCBvZiBzdGFjayBjYXB0dXJpbmcuXG4gICAgaWYgKCFJR05PUkVfRlJBTUVTLmhhc093blByb3BlcnR5KGZyYW1lKSkge1xuICAgICAgbGluZXMucHVzaCh0cmFjZVtpXSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbmRlckxvbmdTdGFja1RyYWNlKGZyYW1lczogTG9uZ1N0YWNrVHJhY2VbXSwgc3RhY2s/OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBsb25nVHJhY2U6IHN0cmluZ1tdID0gW3N0YWNrID8gc3RhY2sudHJpbSgpIDogJyddO1xuXG4gIGlmIChmcmFtZXMpIHtcbiAgICBsZXQgdGltZXN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHRyYWNlRnJhbWVzOiBMb25nU3RhY2tUcmFjZSA9IGZyYW1lc1tpXTtcbiAgICAgIGNvbnN0IGxhc3RUaW1lID0gdHJhY2VGcmFtZXMudGltZXN0YW1wO1xuICAgICAgbGV0IHNlcGFyYXRvciA9XG4gICAgICAgICAgYF9fX19fX19fX19fX19fX19fX19fRWxhcHNlZCAke3RpbWVzdGFtcCAtIGxhc3RUaW1lLmdldFRpbWUoKX0gbXM7IEF0OiAke2xhc3RUaW1lfWA7XG4gICAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IucmVwbGFjZSgvW15cXHdcXGRdL2csICdfJyk7XG4gICAgICBsb25nVHJhY2UucHVzaChzZXBUZW1wbGF0ZS5yZXBsYWNlKFNFUF9UQUcsIHNlcGFyYXRvcikpO1xuICAgICAgYWRkRXJyb3JTdGFjayhsb25nVHJhY2UsIHRyYWNlRnJhbWVzLmVycm9yKTtcblxuICAgICAgdGltZXN0YW1wID0gbGFzdFRpbWUuZ2V0VGltZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBsb25nVHJhY2Uuam9pbihORVdMSU5FKTtcbn1cblxuKFpvbmUgYXMgYW55KVsnbG9uZ1N0YWNrVHJhY2Vab25lU3BlYyddID0gPFpvbmVTcGVjPntcbiAgbmFtZTogJ2xvbmctc3RhY2stdHJhY2UnLFxuICBsb25nU3RhY2tUcmFjZUxpbWl0OiAxMCwgIC8vIE1heCBudW1iZXIgb2YgdGFzayB0byBrZWVwIHRoZSBzdGFjayB0cmFjZSBmb3IuXG4gIC8vIGFkZCBhIGdldExvbmdTdGFja1RyYWNlIG1ldGhvZCBpbiBzcGVjIHRvXG4gIC8vIGhhbmRsZSBoYW5kbGVkIHJlamVjdCBwcm9taXNlIGVycm9yLlxuICBnZXRMb25nU3RhY2tUcmFjZTogZnVuY3Rpb24oZXJyb3I6IEVycm9yKTogc3RyaW5nIHxcbiAgICAgIHVuZGVmaW5lZCB7XG4gICAgICAgIGlmICghZXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRyYWNlID0gKGVycm9yIGFzIGFueSlbKFpvbmUgYXMgYW55KS5fX3N5bWJvbF9fKCdjdXJyZW50VGFza1RyYWNlJyldO1xuICAgICAgICBpZiAoIXRyYWNlKSB7XG4gICAgICAgICAgcmV0dXJuIGVycm9yLnN0YWNrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZW5kZXJMb25nU3RhY2tUcmFjZSh0cmFjZSwgZXJyb3Iuc3RhY2spO1xuICAgICAgfSxcblxuICBvblNjaGVkdWxlVGFzazogZnVuY3Rpb24oXG4gICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIHRhc2s6IFRhc2spOiBhbnkge1xuICAgIGlmIChFcnJvci5zdGFja1RyYWNlTGltaXQgPiAwKSB7XG4gICAgICAvLyBpZiBFcnJvci5zdGFja1RyYWNlTGltaXQgaXMgMCwgbWVhbnMgc3RhY2sgdHJhY2VcbiAgICAgIC8vIGlzIGRpc2FibGVkLCBzbyB3ZSBkb24ndCBuZWVkIHRvIGdlbmVyYXRlIGxvbmcgc3RhY2sgdHJhY2VcbiAgICAgIC8vIHRoaXMgd2lsbCBpbXByb3ZlIHBlcmZvcm1hbmNlIGluIHNvbWUgdGVzdChzb21lIHRlc3Qgd2lsbFxuICAgICAgLy8gc2V0IHN0YWNrVHJhY2VMaW1pdCB0byAwLCBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci96b25lLmpzL2lzc3Vlcy82OThcbiAgICAgIGNvbnN0IGN1cnJlbnRUYXNrID0gWm9uZS5jdXJyZW50VGFzaztcbiAgICAgIGxldCB0cmFjZSA9IGN1cnJlbnRUYXNrICYmIGN1cnJlbnRUYXNrLmRhdGEgJiYgKGN1cnJlbnRUYXNrLmRhdGEgYXMgYW55KVtjcmVhdGlvblRyYWNlXSB8fCBbXTtcbiAgICAgIHRyYWNlID0gW25ldyBMb25nU3RhY2tUcmFjZSgpXS5jb25jYXQodHJhY2UpO1xuICAgICAgaWYgKHRyYWNlLmxlbmd0aCA+IHRoaXMubG9uZ1N0YWNrVHJhY2VMaW1pdCkge1xuICAgICAgICB0cmFjZS5sZW5ndGggPSB0aGlzLmxvbmdTdGFja1RyYWNlTGltaXQ7XG4gICAgICB9XG4gICAgICBpZiAoIXRhc2suZGF0YSkgdGFzay5kYXRhID0ge307XG4gICAgICAodGFzay5kYXRhIGFzIGFueSlbY3JlYXRpb25UcmFjZV0gPSB0cmFjZTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmVudFpvbmVEZWxlZ2F0ZS5zY2hlZHVsZVRhc2sodGFyZ2V0Wm9uZSwgdGFzayk7XG4gIH0sXG5cbiAgb25IYW5kbGVFcnJvcjogZnVuY3Rpb24oXG4gICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIGVycm9yOiBhbnkpOiBib29sZWFuIHtcbiAgICBpZiAoRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID4gMCkge1xuICAgICAgLy8gaWYgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0IGlzIDAsIG1lYW5zIHN0YWNrIHRyYWNlXG4gICAgICAvLyBpcyBkaXNhYmxlZCwgc28gd2UgZG9uJ3QgbmVlZCB0byBnZW5lcmF0ZSBsb25nIHN0YWNrIHRyYWNlXG4gICAgICAvLyB0aGlzIHdpbGwgaW1wcm92ZSBwZXJmb3JtYW5jZSBpbiBzb21lIHRlc3Qoc29tZSB0ZXN0IHdpbGxcbiAgICAgIC8vIHNldCBzdGFja1RyYWNlTGltaXQgdG8gMCwgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvem9uZS5qcy9pc3N1ZXMvNjk4XG4gICAgICBjb25zdCBwYXJlbnRUYXNrID0gWm9uZS5jdXJyZW50VGFzayB8fCBlcnJvci50YXNrO1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgcGFyZW50VGFzaykge1xuICAgICAgICBjb25zdCBsb25nU3RhY2sgPVxuICAgICAgICAgICAgcmVuZGVyTG9uZ1N0YWNrVHJhY2UocGFyZW50VGFzay5kYXRhICYmIHBhcmVudFRhc2suZGF0YVtjcmVhdGlvblRyYWNlXSwgZXJyb3Iuc3RhY2spO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGVycm9yLnN0YWNrID0gKGVycm9yIGFzIGFueSkubG9uZ1N0YWNrID0gbG9uZ1N0YWNrO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyZW50Wm9uZURlbGVnYXRlLmhhbmRsZUVycm9yKHRhcmdldFpvbmUsIGVycm9yKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gY2FwdHVyZVN0YWNrVHJhY2VzKHN0YWNrVHJhY2VzOiBzdHJpbmdbXVtdLCBjb3VudDogbnVtYmVyKTogdm9pZCB7XG4gIGlmIChjb3VudCA+IDApIHtcbiAgICBzdGFja1RyYWNlcy5wdXNoKGdldEZyYW1lcygobmV3IExvbmdTdGFja1RyYWNlKCkpLmVycm9yKSk7XG4gICAgY2FwdHVyZVN0YWNrVHJhY2VzKHN0YWNrVHJhY2VzLCBjb3VudCAtIDEpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXB1dGVJZ25vcmVGcmFtZXMoKSB7XG4gIGlmIChFcnJvci5zdGFja1RyYWNlTGltaXQgPD0gMCkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBmcmFtZXM6IHN0cmluZ1tdW10gPSBbXTtcbiAgY2FwdHVyZVN0YWNrVHJhY2VzKGZyYW1lcywgMik7XG4gIGNvbnN0IGZyYW1lczEgPSBmcmFtZXNbMF07XG4gIGNvbnN0IGZyYW1lczIgPSBmcmFtZXNbMV07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVzMS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGZyYW1lMSA9IGZyYW1lczFbaV07XG4gICAgaWYgKGZyYW1lMS5pbmRleE9mKEVSUk9SX1RBRykgPT0gLTEpIHtcbiAgICAgIGxldCBtYXRjaCA9IGZyYW1lMS5tYXRjaCgvXlxccyphdFxccysvKTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBzZXBUZW1wbGF0ZSA9IG1hdGNoWzBdICsgU0VQX1RBRyArICcgKGh0dHA6Ly9sb2NhbGhvc3QpJztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXMxLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhbWUxID0gZnJhbWVzMVtpXTtcbiAgICBjb25zdCBmcmFtZTIgPSBmcmFtZXMyW2ldO1xuICAgIGlmIChmcmFtZTEgPT09IGZyYW1lMikge1xuICAgICAgSUdOT1JFX0ZSQU1FU1tmcmFtZTFdID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59XG5jb21wdXRlSWdub3JlRnJhbWVzKCk7XG4iXX0=